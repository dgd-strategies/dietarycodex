<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dietary Index Web Calculator</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f7fa;
      color: #2c3e50;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1.5em;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.5em;
    }
    .controls {
      margin-bottom: 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    .controls label {
      cursor: pointer;
      user-select: none;
    }
    #dropzone {
      border: 2px dashed #3498db;
      background-color: #eaf3fb;
      padding: 2em;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #dropzone.hover { background-color: #d6ecfa; }
    #previewContainer,
    #result,
    #charts {
      margin-top: 2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      margin-top: 0.5em;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th { background: #ecf0f1; }
    a {
      color: #2c3e50;
      text-decoration: underline;
      display: inline-block;
      margin-top: 1em;
    }
    .error { color: red; font-weight: bold; }
    #loading {
      display: none;
      text-align: center;
      margin-top: 2em;
    }
    @media (max-width: 600px) {
      .container { padding: 1em; }
      th, td { font-size: 0.8em; }
      .controls { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dietary Index Calculator</h1>

    <div class="controls">
      <label><input type="checkbox" value="DII" checked /> DII</label>
      <label><input type="checkbox" value="MIND" checked /> MIND</label>
      <label><input type="checkbox" value="HEI_2015" checked /> HEI-2015</label>
      <label><input type="checkbox" value="DASH" checked /> DASH</label>
    </div>

    <div id="dropzone">Drag & drop CSV here, or click to select file</div>

    <div id="previewContainer">
      <h3 id="previewTitle" style="display:none;">Preview (first 5 rows)</h3>
      <table id="previewTable"></table>
    </div>

    <div id="loading">⏳ Scoring in progress...</div>
    <div id="result"></div>
    <div id="charts"></div>
  </div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const resultBox = document.getElementById("result");
    const previewTable = document.getElementById("previewTable");
    const previewTitle = document.getElementById("previewTitle");
    const loading = document.getElementById("loading");

    // Utility functions
    function quantile(arr, q) {
      const sorted = arr.slice().sort((a, b) => a - b);
      const pos = (sorted.length - 1) * q;
      const lo = Math.floor(pos), hi = Math.ceil(pos);
      return sorted[lo] + (sorted[hi] - sorted[lo]) * (pos - lo);
    }

    function computeStats(values) {
      const n = values.length;
      const mean = values.reduce((a, b) => a + b, 0) / n;
      const sq = values.map(v => (v - mean) ** 2);
      const std = Math.sqrt(sq.reduce((a, b) => a + b, 0) / (n - 1));
      return {
        mean: mean.toFixed(2),
        std: std.toFixed(2),
        min: Math.min(...values).toFixed(2),
        max: Math.max(...values).toFixed(2),
        median: quantile(values, 0.5).toFixed(2),
        quintiles: [0.2,0.4,0.6,0.8].map(q => quantile(values, q).toFixed(2))
      };
    }

    // Handle file selection
    dropzone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file"; input.accept = ".csv";
      input.onchange = () => handleFile(input.files[0]);
      input.click();
    });
    dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("hover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("hover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault(); dropzone.classList.remove("hover");
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    async function handleFile(file) {
      resultBox.innerHTML = "";
      previewTable.innerHTML = "";
      previewTitle.style.display = "none";
      document.getElementById("charts").innerHTML = "";
      loading.style.display = "block";

      if (!file.name.toLowerCase().endsWith('.csv')) {
        resultBox.innerHTML = "<div class='error'>Only CSV files are supported.</div>";
        loading.style.display = "none";
        return;
      }

      // Show preview
      const text = await file.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[0];
      const sample = rows.slice(1, 6);
      let html = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      sample.forEach(r => html += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>');
      previewTable.innerHTML = html;
      previewTitle.style.display = 'block';

      // Prepare indices query
      const selected = Array.from(document.querySelectorAll('.controls input:checked')).map(cb => cb.value);
      const params = new URLSearchParams();
      selected.forEach(i => params.append('indices', i));

      // Upload and get CSV
      try {
        const res = await fetch(`http://localhost:8000/score?${params}`, { method: 'POST', body: new FormData().append('file', file) });
        if (!res.ok) throw new Error((await res.json()).detail);
        const blob = await res.blob();
        const csvText = await blob.text();
        const data = csvText.trim().split('\n').map(r => r.split(','));
        const idx = data[0].reduce((m, h, i) => (m[h] = i, m), {});

        // Compute and display stats
        let summary = '<h3>Summary Statistics:</h3><ul>';
        selected.forEach(name => {
          const vals = data.slice(1).map(r => parseFloat(r[idx[name]])).filter(v => !isNaN(v));
          const s = computeStats(vals);
          summary += `<li><b>${name}</b> – mean: ${s.mean}, std: ${s.std}, min: ${s.min}, max: ${s.max}, median: ${s.median}, quintiles: ${s.quintiles.join(', ')}</li>`;
          // Plot histogram
          const chartDiv = document.createElement('div');
          document.getElementById('charts').append(chartDiv);
          Plotly.newPlot(chartDiv, [{ x: vals, type: 'histogram', name }], { title: `${name} Distribution`, margin:{ t:40 }}, { responsive:true });
        });
        summary += '</ul>';
        resultBox.innerHTML = summary;

        // Trigger download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name.replace(/\.csv$/, '') + '_scores.csv';
        a.click();
        URL.revokeObjectURL(url);

      } catch (err) {
        console.error(err);
        resultBox.innerHTML = `<div class='error'>${err.message}</div>`;
      } finally {
        loading.style.display = 'none';
      }
    }
  </script>
</body>
</html>
