<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dietary Index Calculator</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
              rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
              rel="stylesheet" />
        <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
        <style>
    :root {
      --bg: #f9fafb;
      --text: #212529;
      --primary: #0d6efd;
      --border: #dee2e6;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111316;
        --text: #e9ecef;
        --primary: #339af0;
        --border: #333;
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin: 1rem 0;
    }
    .container {
      max-width: 960px;
      padding: 1rem;
      margin: auto;
    }
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
      cursor: pointer;
    }
    #dropzone {
      border: 2px dashed var(--primary);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      background: rgba(13,110,253,0.05);
      transition: background 0.2s;
      cursor: pointer;
    }
    #dropzone.hover {
      background: rgba(13,110,253,0.15);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    #previewContainer {
      overflow-x: auto;
      margin-top: 1rem;
    }
    #previewTable {
      min-width: 600px;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid var(--border);
    }
    th {
      background: rgba(0,0,0,0.04);
    }
    a {
      color: var(--primary);
    }
    #loading {
      display: none;
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
    }
    .error { color: #d9534f; font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="container my-4">
            <h1>Dietary Index Calculator</h1>
            <div class="controls d-flex flex-wrap gap-2 align-items-center mb-3">
                <label class="form-check">
                    <input class="form-check-input" type="checkbox" value="DII" checked />
                    DII
                </label>
                <label class="form-check">
                    <input class="form-check-input" type="checkbox" value="MIND" checked />
                    MIND
                </label>
                <label class="form-check">
                    <input class="form-check-input" type="checkbox" value="HEI_2015" checked />
                    HEI‑2015
                </label>
                <label class="form-check">
                    <input class="form-check-input" type="checkbox" value="DASH" checked />
                    DASH
                </label>
                <input id="apiBase"
                       class="form-control form-control-sm ms-auto"
                       style="max-width:240px"
                       placeholder="http://localhost:8000" />
                <div id="apiStatus" class="small ms-2"></div>
            </div>
            <div id="dropzone" class="mb-3">Drag & drop CSV here, or click to select file</div>
            <div id="previewContainer">
                <h3 id="previewTitle" style="display:none;">
                    Preview (first 5 rows)
                    <button id="clearBtn"
                            type="button"
                            class="btn-close float-end"
                            aria-label="Clear preview"
                            style="display:none"></button>
                </h3>
                <table id="previewTable">
                </table>
            </div>
            <div id="loading">⏳ Scoring in progress...</div>
            <div id="result"></div>
            <div id="charts"></div>
        </div>
        <script>
    const dropzone = document.getElementById('dropzone');
    const resultBox = document.getElementById('result');
    const previewTable = document.getElementById('previewTable');
    const previewTitle = document.getElementById('previewTitle');
    const clearBtn = document.getElementById('clearBtn');
    const loading = document.getElementById('loading');
    const apiBaseInput = document.getElementById('apiBase');
    const apiStatus = document.getElementById('apiStatus');
    const paramsQP = new URLSearchParams(location.search);
    const storedApi = localStorage.getItem('apiBase');
    if (paramsQP.get('api')) {
      apiBaseInput.value = paramsQP.get('api');
    } else if (storedApi) {
      apiBaseInput.value = storedApi;
    }
    apiBaseInput.addEventListener('change', () => {
      localStorage.setItem('apiBase', apiBaseInput.value);
    });

    const apiUrl = (path) =>
      (apiBaseInput.value || location.origin).replace(/\/+$/, '') + path;

    function quantile(arr, q) {
      const sorted = arr.slice().sort((a, b) => a - b);
      const pos = (sorted.length - 1) * q;
      const lo = Math.floor(pos), hi = Math.ceil(pos);
      return sorted[lo] + (sorted[hi] - sorted[lo]) * (pos - lo);
    }
    function computeStats(values) {
      const n = values.length;
      const mean = values.reduce((a,b) => a + b, 0) / n;
      const sq = values.map(v => (v - mean)**2);
      const std = Math.sqrt(sq.reduce((a,b) => a + b, 0) / (n - 1));
      return {
        mean: mean.toFixed(2),
        std: std.toFixed(2),
        min: Math.min(...values).toFixed(2),
        max: Math.max(...values).toFixed(2),
        median: quantile(values,0.5).toFixed(2),
        quintiles: [0.2,0.4,0.6,0.8].map(q => quantile(values,q).toFixed(2))
      };
    }
    dropzone.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = () => handleFile(input.files[0]);
      input.click();
    });
    clearBtn.addEventListener('click', () => {
      resultBox.innerHTML = '';
      previewTable.innerHTML = '';
      previewTitle.style.display = 'none';
      document.getElementById('charts').innerHTML = '';
      clearBtn.style.display = 'none';
      console.log('Preview cleared');
    });
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('hover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('hover'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('hover');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    // Load bundled template on startup
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('Using API', apiBaseInput.value || location.origin);
      try {
        const ping = await fetch(apiUrl('/ping'));
        console.log('API ping', ping.status, ping.statusText);
        apiStatus.textContent = `API ${ping.status} ${ping.statusText}`;
        apiStatus.className = 'small ms-2 ' + (ping.ok ? 'text-success' : 'text-danger');
        if (!ping.ok) {
          console.warn('API ping not OK', ping.status, ping.statusText);
        }
  
      } catch (err) {
        console.warn('API ping failed', err);
        const msg = err instanceof Error ? err.message : String(err);
        apiStatus.textContent = `API ping failed: ${msg}`;
        apiStatus.className = 'small ms-2 text-danger';
      }
      try {
        const res = await fetch('./assets/template.csv');
        if (!res.ok) throw new Error(`template load ${res.status}`);
        const blob = await res.blob();
        const file = new File([blob], 'template.csv', { type: 'text/csv' });
        console.log('Loaded default template');
        handleFile(file);
      } catch (err) {
        console.error('Could not preload template', err);
      }
    });

    async function handleFile(file) {
      resultBox.innerHTML = '';
      previewTable.innerHTML = '';
      previewTitle.style.display = 'none';
      document.getElementById('charts').innerHTML = '';
      clearBtn.style.display = 'none';
      loading.style.display = 'block';
      console.log('Processing file', file.name);
      if (!file.name.toLowerCase().endsWith('.csv')) {
        resultBox.innerHTML = "<div class='error'>Only CSV files are supported.</div>";
        loading.style.display = 'none';
        return;
      }
      // Show preview
      const text = await file.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[0];
      const sample = rows.slice(1,6);
      let html = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      sample.forEach(r => html += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>');
      previewTable.innerHTML = html;
      previewTitle.style.display = 'block';
      clearBtn.style.display = 'inline-block';
      console.log('Loaded file', file.name);

      const selected = Array.from(document.querySelectorAll('.controls input:checked')).map(cb => cb.value);
      const params = new URLSearchParams();
      selected.forEach(i => params.append('indices', i));

      try {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch(apiUrl(`/score?${params}`), {
          method: 'POST',
          body: fd,
        });
        if (!res.ok) {
          let detail = '';
          try { detail = (await res.json()).detail; } catch {}
          
          if (!detail) {
            const text = await res.text().catch(() => '');
            detail = text.trim();
          }
          if (res.status === 404) {
            detail = detail || 'Endpoint not found';
          } else if (res.status === 405) {
            detail = detail || 'Method not allowed';
          }
          const statusLine = `HTTP ${res.status} ${res.statusText}`;
          throw new Error(detail ? `${statusLine} - ${detail}` : statusLine);
        }
        const info = await res.json();
        const dl = await fetch(apiUrl(`/download/${info.filename}`));
        if (!dl.ok) {
          throw new Error(`Download error ${dl.status} ${dl.statusText}`);
        }
        const blob = await dl.blob();
        const csvText = await blob.text();
        const data = csvText.trim().split('\n').map(r => r.split(','));
        const idx = data[0].reduce((m,h,i) => (m[h]=i,m), {});
        let summary = '<h3>Summary Statistics:</h3><ul>';
        selected.forEach(name => {
          const vals = data.slice(1).map(r => parseFloat(r[idx[name]])).filter(v => !isNaN(v));
          const s = computeStats(vals);
          summary += `<li><b>${name}</b> – mean: ${s.mean}, std: ${s.std}, min: ${s.min}, max: ${s.max}, median: ${s.median}, quintiles: ${s.quintiles.join(', ')}</li>`;
          const chartDiv = document.createElement('div');
          document.getElementById('charts').append(chartDiv);
          Plotly.newPlot(chartDiv,[{x:vals,type:'histogram',name}],{title:`${name} Distribution`,margin:{t:40}}, {responsive:true});
        });
        summary += '</ul>';
        resultBox.innerHTML = summary;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name.replace(/\.csv$/, '') + '_scores.csv';
        a.click();
        URL.revokeObjectURL(url);
        console.log('Scoring complete, results downloaded');
      } catch(err) {
        console.error('Scoring failed', err);
        let msg = err instanceof Error ? `${err.name}: ${err.message}` : String(err);
        if (msg.includes('Failed to fetch')) {
          msg = `Failed to reach ${apiUrl('/score')} – the server may be down or CORS blocked.`;
        }
        resultBox.innerHTML = `<div class='error'><b>${msg}</b><br><small>Endpoint: ${apiUrl('/score')}<br>API base: ${apiBaseInput.value || 'http://localhost:8000'}</small></div>`;
      } finally {
        loading.style.display = 'none';
      }
    }
        </script>
    </body>
</html>
